<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<title>ç·¨è¼¯ï¼š{{ boss.name }}</title>
<link rel="stylesheet" href="/static/css/style.css">
<style>
/* æ•´é«”é»‘ç°ä¸»é¡Œï¼ˆä¿ç•™ä½ è¦çš„å¤–è§€ï¼‰ */
body{background:#2f2b28;color:#eee;font-family:"å¾®è»Ÿæ­£é»‘é«”",Arial;margin:0;padding:18px}
.container{max-width:1100px;margin:0 auto}
.form-wrap{background:#312416;padding:20px;border-radius:8px;margin:0 auto;box-shadow:0 2px 8px rgba(0,0,0,0.4)}
h2{color:#fff;margin:0 0 14px}

/* è¡¨å–®å…ƒä»¶ */
label{display:block;margin:12px 0 6px;font-weight:600;color:#f3e6d7}
input[type="text"], textarea, select {width:100%;padding:10px;border-radius:6px;border:1px solid #594330;background:#fff;color:#000}
textarea{min-height:90px;resize:vertical}

/* ç°¡ç¨± tags */
.tags-box{min-height:46px;padding:8px;background:#2f220f;border:1px dashed #6b4b2a;color:#fff;border-radius:6px}
.tag{display:inline-flex;align-items:center;background:#ff9c2b;color:#000;padding:6px 10px;border-radius:6px;margin:4px;font-weight:700;cursor:move}
.tag .x{margin-left:8px;background:transparent;border:none;cursor:pointer;font-weight:800}

/* æ˜ŸæœŸçš„æŒ‰éˆ•æ’ç‰ˆï¼ˆåƒåœ–2ï¼‰ */
.weekline{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
.weekline label{display:flex;align-items:center;gap:6px;padding:6px 10px;background:#3a2b17;border-radius:6px;border:1px solid #594330;color:#f3e6d7;cursor:pointer}

/* æ™‚é–“ tagï¼ˆå›ºå®šé¦–é ˜ï¼‰ */
.time-tag{display:inline-block;background:#ff9c2b;padding:6px 10px;border-radius:6px;margin:6px;color:#000;font-weight:700}
.time-tag button{margin-left:8px;border:none;background:transparent;cursor:pointer;font-weight:700}

/* æŒ‰éˆ• */
.btn{display:inline-block;padding:8px 12px;border-radius:6px;background:#e67e22;color:#fff;text-decoration:none;cursor:pointer;border:0;font-weight:700}
.btn.blue{background:#1e6bff}
.btn.red{background:#d9534f}
.btn.gray{background:#6b6b6b}
.btn.small{padding:6px 10px}

/* å€å¡Šé–“è· */
.row{margin-bottom:10px}

/* æ–°å¢æ™‚é–“å½ˆçª—ï¼ˆä¸‹æ‹‰ä¸‰æ®µå¼ï¼‰ */
#time-dialog-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.6);z-index:9999}
#time-dialog{background:#f9f1e0;padding:18px;border-radius:10px;width:320px;color:#000;box-shadow:0 6px 20px rgba(0,0,0,0.5);text-align:center}
#time-dialog select{padding:8px;border-radius:6px;margin:6px 4px;font-size:16px}

/* å°è¢å¹•é©é… */
@media(max-width:700px){
  .container{padding:12px}
  #time-dialog{width:92%}
}
</style>
</head>
<body>
<div class="container">
  <div class="form-wrap">
    <h2>ç·¨è¼¯ï¼š{{ boss.name }}</h2>

    <form method="POST" enctype="multipart/form-data" onsubmit="syncFixedHidden(); updateShortHidden()">

      <!-- ç‹å -->
      <div class="row">
        <label>æ­£å¼ç‹åï¼š</label>
        <input type="text" name="name" value="{{ boss.name }}" required>
      </div>

      <!-- è£œå……èªªæ˜ -->
      <div class="row">
        <label>è£œå……èªªæ˜ï¼š</label>
        <textarea name="desc">{{ boss.desc }}</textarea>
      </div>

      <!-- ç°¡ç¨±ï¼ˆtagï¼‰ -->
      <div class="row">
        <label>ç°¡ç¨±ï¼ˆEnter æˆ–ï¼‹åŠ å…¥ï¼Œå¯æ‹–æ›³æ’åºï¼‰ï¼š</label>
        <div id="tags_box" class="tags-box"></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <input id="shortname_input" type="text" placeholder="è¼¸å…¥ç°¡ç¨±æŒ‰ Enter æˆ– +">
          <button type="button" class="btn small" onclick="addTagFromInput()">ï¼‹</button>
        </div>
        <input type="hidden" name="shortname" id="shortname_hidden">
      </div>

      <!-- é‡ç”Ÿæ˜ŸæœŸ -->
      <div class="row">
        <label>é‡ç”Ÿæ˜ŸæœŸï¼š</label>
        <div class="weekline">
          {% for day in ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'] %}
            {% set idx = loop.index0 %}
            <label>
              <input type="checkbox" name="weekday" value="{{ idx }}" {% if idx|string in boss.weekday %}checked{% endif %}>
              {{ day }}
            </label>
          {% endfor %}
        </div>
      </div>

      <!-- é¦–é ˜é¡å‹ -->
      <div class="row">
        <label>é¦–é ˜é¡å‹ï¼š</label>
        <select name="respawn_type" id="respawn_type">
          <option value="cycle" {% if boss.respawn_type == 'cycle' %}selected{% endif %}>é€±æœŸé¦–é ˜</option>
          <option value="fixed" {% if boss.respawn_type == 'fixed' %}selected{% endif %}>å›ºå®šé¦–é ˜</option>
        </select>
      </div>

      <!-- é€±æœŸï¼ˆåªåœ¨é¸ cycle æ™‚é¡¯ç¤ºï¼‰ -->
      <div id="cycle-section" class="row" style="display:none">
        <label>é‡ç”Ÿé€±æœŸï¼ˆæ™‚ï½œåˆ†ï½œç§’ï¼‰ï¼š</label>
        <div class="hms">
          <select name="respawn_h">
            {% for i in range(0,24) %}
              <option value="{{ i }}" {% if i==respawn_h %}selected{% endif %}>{{ "%02d"|format(i) }}</option>
            {% endfor %}
          </select> :
          <select name="respawn_m">
            {% for i in range(0,60) %}
              <option value="{{ i }}" {% if i==respawn_m %}selected{% endif %}>{{ "%02d"|format(i) }}</option>
            {% endfor %}
          </select> :
          <select name="respawn_s">
            {% for i in range(0,60) %}
              <option value="{{ i }}" {% if i==respawn_s %}selected{% endif %}>{{ "%02d"|format(i) }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- å›ºå®šï¼ˆåªåœ¨é¸ fixed æ™‚é¡¯ç¤ºï¼‰ -->
      <div id="fixed-section" class="row" style="display:none">
        <label>å›ºå®šé‡ç”Ÿæ™‚é–“</label>

        <!-- å·¦ä¸Šä¸‰å€‹æ“ä½œ -->
        <div style="margin:8px 0; display:flex; gap:8px; flex-wrap:wrap">
          <button type="button" id="open-time-dialog" class="btn">â° å¢åŠ æ™‚é–“</button>
          <button type="button" id="preset-add" class="btn blue">å¿«é€Ÿé è¨­</button>
          <button type="button" id="copy-time" class="btn small">ğŸ” é‡è¤‡è¨­å®šï¼ˆæ’åºï¼‰</button>
          <button type="button" id="clear-time" class="btn red">ğŸ—‘ å…¨éƒ¨ç§»é™¤</button>
        </div>

        <!-- å¿«é€Ÿé è¨­é¢æ¿ï¼ˆé è¨­å¸¸ç”¨æ™‚æ®µæŒ‰éˆ•ï¼‰ -->
        <div id="preset-panel" style="margin-bottom:10px; display:none">
          <!-- ä½ å¯ä»¥ç·¨è¼¯ä¸‹é¢çš„æŒ‰éˆ•æ™‚æ®µ -->
          <button type="button" class="btn small preset-btn" data-time="01:00:00">01:00</button>
          <button type="button" class="btn small preset-btn" data-time="03:00:00">03:00</button>
          <button type="button" class="btn small preset-btn" data-time="05:00:00">05:00</button>
          <button type="button" class="btn small preset-btn" data-time="07:00:00">07:00</button>
          <button type="button" class="btn small preset-btn" data-time="09:00:00">09:00</button>
          <button type="button" class="btn small preset-btn" data-time="11:00:00">11:00</button>
          <button type="button" class="btn small preset-btn" data-time="13:00:00">13:00</button>
          <button type="button" class="btn small preset-btn" data-time="15:00:00">15:00</button>
          <button type="button" class="btn small preset-btn" data-time="17:00:00">17:00</button>
          <button type="button" class="btn small preset-btn" data-time="19:00:00">19:00</button>
          <button type="button" class="btn small preset-btn" data-time="21:00:00">21:00</button>
          <button type="button" class="btn small preset-btn" data-time="23:00:00">23:00</button>
        </div>

<!-- æ™‚é–“åˆ—è¡¨ -->
<div id="fixed-time-list" style="margin-top:8px; min-height:48px">
  <!-- å¦‚æœ boss.respawn_period æ˜¯ listï¼Œå…ˆæ¸²æŸ“ç¾æœ‰æ™‚é–“ -->
  {% if boss.respawn_type == 'fixed' %}
    {% if boss.respawn_period is sequence %}
      {% for t in boss.respawn_period %}
        <span class="time-tag" data-time="{{ t }}">{{ t }} <button type="button" class="remove-time">x</button></span>
      {% endfor %}
    {% elif boss.respawn_period is string %}
      <span class="time-tag" data-time="{{ boss.respawn_period }}">{{ boss.respawn_period }} <button type="button" class="remove-time">x</button></span>
    {% endif %}
  {% endif %}
</div>

        <!-- éš±è—æ¬„ä½ï¼šé€å‡ºæ™‚ç”¨é€—è™Ÿåˆ†éš” -->
        <input type="hidden" id="fixed_times_hidden" name="fixed_times" value="{% if boss.respawn_type=='fixed' and boss.respawn_period is sequence %}{{ boss.respawn_period | join(',') }}{% elif boss.respawn_type=='fixed' and boss.respawn_period is string %}{{ boss.respawn_period }}{% else %}{% endif %}">
      </div>

      <!-- åœ–ç‰‡ -->
      <div class="row">
        <label>ç›®å‰åœ–ç‰‡ï¼š</label>
        {% if boss.img %}
          <img src="{{ boss.img }}" style="max-height:140px;display:block;margin-bottom:8px">
        {% endif %}
        <label>ä¸Šå‚³æ–°åœ–ç‰‡ï¼ˆæœƒå–ä»£èˆŠåœ–ï¼‰ï¼š</label>
        <input type="file" name="img_upload" accept="image/*" onchange="previewFile(this)">
        <input type="text" name="img" value="{{ boss.img }}" placeholder="æˆ–è²¼ä¸Šåœ–ç‰‡ç¶²å€ (http...)">
        <img id="img_preview" style="display:none;max-height:140px;margin-top:8px">
      </div>

      <!-- æ“ä½œæŒ‰éˆ• -->
      <div style="margin-top:16px; display:flex; gap:12px;">
        <button class="btn" type="submit">å„²å­˜</button>
        <button type="button" class="btn gray" onclick="window.history.back()">å–æ¶ˆ</button>
      </div>

    </form>
  </div>
</div>

<!-- æ–°å¢æ™‚é–“å½ˆçª—ï¼ˆä¸‹æ‹‰ä¸‰æ®µå¼ï¼‰ -->
<div id="time-dialog-backdrop">
  <div id="time-dialog">
    <h3>æ–°å¢å›ºå®šæ™‚é–“</h3>
    <div style="margin-top:12px;">
      <select id="sel-h"></select> :
      <select id="sel-m"></select> :
      <select id="sel-s"></select>
    </div>
    <div style="margin-top:14px;">
      <button id="time-ok" class="btn">ç¢ºå®š</button>
      <button id="time-cancel" class="btn gray">é—œé–‰</button>
    </div>
  </div>
</div>

<script>
/* ---------- åœ–ç‰‡é è¦½ ---------- */
function previewFile(input){
  const file = input.files?.[0];
  const img = document.getElementById('img_preview');
  if(!file){ img.style.display='none'; return; }
  img.src = URL.createObjectURL(file);
  img.style.display='block';
}

/* ---------- TAGï¼ˆç°¡ç¨±ï¼‰ç³»çµ± ---------- */
const tagsBox = document.getElementById("tags_box");
const shortInput = document.getElementById("shortname_input");
const shortHidden = document.getElementById("shortname_hidden");
let dragItem = null;

shortInput.addEventListener("keydown", e => {
  if(e.key === "Enter"){ e.preventDefault(); addTagFromInput(); }
});

function addTagFromInput(){
  const v = shortInput.value.trim();
  if(!v) return;
  const parts = v.split(/[\s,]+/);
  const exist = new Set([...tagsBox.querySelectorAll(".tag")].map(t => t.dataset.value));
  parts.forEach(p=>{
    const word = p.trim();
    if(!word) return;
    if(exist.has(word)) return;
    const span = document.createElement("span");
    span.className = "tag";
    span.dataset.value = word;
    span.innerHTML = word + ' <button class="x" type="button" onclick="removeTag(this)">Ã—</button>';
    span.draggable = true;
    span.addEventListener("dragstart", ()=>dragItem = span);
    span.addEventListener("dragover", e=>e.preventDefault());
    span.addEventListener("drop", e=>{
      e.preventDefault();
      if(dragItem && dragItem !== span) tagsBox.insertBefore(dragItem, span);
      updateShortHidden();
    });
    tagsBox.appendChild(span);
    exist.add(word);
  });
  shortInput.value = "";
  updateShortHidden();
}

function removeTag(el){
  el.closest(".tag").remove();
  updateShortHidden();
}

function updateShortHidden(){
  const arr = [...tagsBox.querySelectorAll(".tag")].map(t => t.dataset.value);
  shortHidden.value = arr.join(",");
}

/* åˆå§‹åŒ– tagsï¼ˆå¾ boss.shortnameï¼‰ */
document.addEventListener("DOMContentLoaded", ()=>{
  try{
    const raw = {{ boss.shortname | tojson }};
    raw.forEach(w=>{
      const span = document.createElement("span");
      span.className = "tag";
      span.dataset.value = w;
      span.innerHTML = w + ' <button class="x" type="button" onclick="removeTag(this)">Ã—</button>';
      span.draggable = true;
      span.addEventListener("dragstart", ()=>dragItem = span);
      span.addEventListener("dragover", e=>e.preventDefault());
      span.addEventListener("drop", e=>{
        e.preventDefault();
        if(dragItem && dragItem !== span) tagsBox.insertBefore(dragItem, span);
        updateShortHidden();
      });
      tagsBox.appendChild(span);
    });
    updateShortHidden();
  }catch(e){
    console.warn("init tags failed", e);
  }
});

/* ---------- å›ºå®š / é€±æœŸ åˆ‡æ›é¡¯ç¤º ---------- */
function updateSections(){
  const type = document.getElementById("respawn_type").value;
  document.getElementById("cycle-section").style.display = (type === "cycle") ? "block" : "none";
  document.getElementById("fixed-section").style.display = (type === "fixed") ? "block" : "none";
}
document.getElementById("respawn_type").addEventListener("change", updateSections);
document.addEventListener("DOMContentLoaded", updateSections);

/* ---------- å›ºå®šæ™‚é–“åˆ—è¡¨æ“ä½œ ---------- */
const fixedList = document.getElementById("fixed-time-list");
const fixedHidden = document.getElementById("fixed_times_hidden");

/* åŒæ­¥éš±è—æ¬„ä½ï¼ˆåœ¨é€å‡ºå‰å‘¼å«ï¼‰ */
function syncFixedHidden(){
  const arr = [...fixedList.querySelectorAll(".time-tag")].map(t => t.dataset.time);
  fixedHidden.value = arr.join(",");
}

/* åœ¨é é¢å…ˆç¶å®š X æŒ‰éˆ•ï¼ˆç§»é™¤ï¼‰èˆ‡æ•´ç† datasetï¼ˆè‹¥ç”¨ server renderï¼‰ */
document.addEventListener("click", function(e){
  if(e.target && e.target.classList && e.target.classList.contains("remove-time")){
    const parent = e.target.closest(".time-tag");
    if(parent) parent.remove();
    syncFixedHidden();
  }
});

/* å»é‡ã€æ’åº (HH:MM:SS) - ç”¨æ–¼é‡è¤‡è¨­å®šæŒ‰éˆ• */
function normalizeTimes(arr){
  // ä¿è­‰æ ¼å¼ HH:MM:SS ä¸¦æ’åº
  const fixed = arr.map(t=>{
    if(typeof t!=='string') return null;
    let part = t.trim();
    if(part.length===5) part = part + ':00';
    return part.padStart(8,'0');
  }).filter(Boolean);
  // ç¯©æ‰éæ³•æ ¼å¼
  const ok = fixed.filter(t=>/^\d{2}:\d{2}:\d{2}$/.test(t));
  ok.sort();
  // å»é‡
  return [...new Set(ok)];
}

/* é‡è¤‡è¨­å®šï¼ˆæ’åºä¸¦é‡æ–°æ¸²æŸ“ï¼‰ */
document.getElementById("copy-time").addEventListener("click", ()=>{
  const arr = [...fixedList.querySelectorAll(".time-tag")].map(t=>t.dataset.time);
  if(arr.length===0){ alert("ç›®å‰æ²’æœ‰ä»»ä½•æ™‚é–“å¯ä»¥æ’åºã€‚"); return; }
  const res = normalizeTimes(arr);
  fixedList.innerHTML = "";
  res.forEach(t=>{
    const span = document.createElement("span");
    span.className = "time-tag";
    span.dataset.time = t;
    span.innerHTML = `${t} <button type="button" class="remove-time">x</button>`;
    fixedList.appendChild(span);
  });
  syncFixedHidden();
});

/* å…¨éƒ¨ç§»é™¤ */
document.getElementById("clear-time").addEventListener("click", ()=>{
  if(!confirm("ç¢ºå®šå…¨éƒ¨ç§»é™¤ï¼Ÿ")) return;
  fixedList.innerHTML = "";
  syncFixedHidden();
});

/* é è¨­æŒ‰éˆ•é¢æ¿ toggle */
document.getElementById("preset-add").addEventListener("click", ()=>{
  const panel = document.getElementById("preset-panel");
  panel.style.display = (panel.style.display==='none' || panel.style.display==='') ? 'block' : 'none';
});

/* å¿«é€Ÿé è¨­æŒ‰éˆ•åŠ å…¥ */
document.querySelectorAll(".preset-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const t = btn.dataset.time;
    addTimeTagIfNotExist(t);
  });
});

/* æ–°å¢æ™‚é–“ï¼šè‹¥ä¸å­˜åœ¨å‰‡åŠ å…¥ä¸¦åŒæ­¥ */
function addTimeTagIfNotExist(t){
  // å°‡ 0:0:0 æˆ– 00:00:00 è½‰æˆ HH:MM:SS
  let time = t.trim();
  if(time.length === 5) time = time + ":00";
  // çµ±ä¸€è£œå…©ä½
  const parts = time.split(":").map(x => x.padStart(2,'0'));
  if(parts.length !== 3) return;
  const norm = `${parts[0]}:${parts[1]}:${parts[2]}`;
  // å¦‚æœå·²å­˜åœ¨å°±è·³é
  const exist = [...fixedList.querySelectorAll(".time-tag")].some(e => e.dataset.time === norm);
  if(exist) return;
  const span = document.createElement("span");
  span.className = "time-tag";
  span.dataset.time = norm;
  span.innerHTML = `${norm} <button type="button" class="remove-time">x</button>`;
  fixedList.appendChild(span);
  syncFixedHidden();
}

/* ---------- ä¸‹æ‹‰ä¸‰æ®µå¼å½ˆçª—ï¼ˆå¢åŠ æ™‚é–“ï¼‰ ---------- */
const backdrop = document.getElementById("time-dialog-backdrop");
const selH = document.getElementById("sel-h");
const selM = document.getElementById("sel-m");
const selS = document.getElementById("sel-s");
for(let i=0;i<24;i++) selH.innerHTML += `<option value="${String(i).padStart(2,'0')}">${String(i).padStart(2,'0')}</option>`;
for(let i=0;i<60;i++){ selM.innerHTML += `<option value="${String(i).padStart(2,'0')}">${String(i).padStart(2,'0')}</option>`; selS.innerHTML += `<option value="${String(i).padStart(2,'0')}">${String(i).padStart(2,'0')}</option>`; }

document.getElementById("open-time-dialog").addEventListener("click", ()=>{
  backdrop.style.display = "flex";
});
document.getElementById("time-cancel").addEventListener("click", ()=>backdrop.style.display='none');
document.getElementById("time-ok").addEventListener("click", ()=>{
  const h = selH.value;
  const m = selM.value;
  const s = selS.value;
  const t = `${h}:${m}:${s}`;
  addTimeTagIfNotExist(t);
  backdrop.style.display = 'none';
});

/* ---------- submit å‰ç¢ºä¿ fixed hidden æœ‰å€¼ ---------- */
document.querySelector('form').addEventListener('submit', ()=>{
  syncFixedHidden();
  updateShortHidden();
});

/* ---------- é é¢ä¸€é–‹å§‹ï¼ˆå¯èƒ½ server å·²æ¸²æŸ“äº† time-tagï¼‰ï¼Œè£œä¸Š dataset/time ä¸¦åŒæ­¥ hidden ---------- */
document.addEventListener("DOMContentLoaded", ()=>{
  // æœ‰äº› server render çš„ .time-tag åªæœ‰æ–‡å­—ï¼Œè£œ dataset.time
  [...fixedList.querySelectorAll(".time-tag")].forEach(el=>{
    if(!el.dataset.time){
      const txt = el.textContent.trim().replace('x','').trim();
      el.dataset.time = txt.length===5? txt+':00' : txt;
    }
  });
  syncFixedHidden();

  // è‹¥é é¢è¼‰å…¥æ™‚æœ‰å›ºå®šæ™‚é–“ä½† respawn_type æ˜¯ fixedï¼Œé¡¯ç¤º fixed å€å¡Š
  updateSections();
});
</script>
</body>
</html>